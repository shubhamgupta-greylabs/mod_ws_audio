# Makefile for mod_ws_audio (C++)
# 
# Build instructions:
# 1. Install dependencies: libwebsockets-dev, libcjson-dev
# 2. Set FREESWITCH_SRC to your FreeSWITCH source directory
# 3. Run: make && sudo make install

FREESWITCH_SRC ?= /usr/local/src/freeswitch
MODULE_NAME = mod_ws_audio

# Compiler and flags# Makefile for mod_ws_audio
# 
# Build instructions:
# 1. Install dependencies: libwebsockets-dev, libcjson-dev
# 2. Set FREESWITCH_SRC to your FreeSWITCH source directory
# 3. Run: make && sudo make install

# Compiler and flags
CC = gcc
CFLAGS = -fPIC -O2 -fomit-frame-pointer -ffast-math -Wall -std=c99 -pedantic \
         -I$(FREESWITCH_SRC)/src/include \
         -I$(FREESWITCH_SRC)/libs/apr/include \
         -I$(FREESWITCH_SRC)/libs/apr-util/include \
         -DSWITCH_API_VISIBILITY=1 -DHAVE_VISIBILITY=1

# Libraries
LDFLAGS = -shared -Wl,-x
LIBS = -lwebsockets -lcjson

# Installation directories
MODDIR ?= /usr/lib/freeswitch/mod
CONFDIR ?= /etc/freeswitch/autoload_configs

# Source files
SOURCES = mod_ws_audio.cpp
OBJECTS = $(SOURCES:.c=.o)
TARGET = $(MODULE_NAME).so

# Default target
all: $(TARGET)

$(TARGET): $(OBJECTS)
	$(CC) $(LDFLAGS) -o $@ $^ $(LIBS)

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

install: $(TARGET)
	sudo mkdir -p $(MODDIR)
	sudo cp $(TARGET) $(MODDIR)/
	sudo chown freeswitch:freeswitch $(MODDIR)/$(TARGET)
	sudo chmod 755 $(MODDIR)/$(TARGET)
	@echo "Module installed to $(MODDIR)/$(TARGET)"
	@echo "Add '<load module=\"$(MODULE_NAME)\"/>' to $(CONFDIR)/modules.conf.xml"

clean:
	rm -f $(OBJECTS) $(TARGET)

uninstall:
	sudo rm -f $(MODDIR)/$(TARGET)

# Development helpers
debug: CFLAGS += -g -DDEBUG
debug: $(TARGET)

check-deps:
	@echo "Checking dependencies..."
	@pkg-config --exists libwebsockets || echo "libwebsockets-dev not found"
	@pkg-config --exists libcjson || echo "libcjson-dev not found"
	@test -d $(FREESWITCH_SRC) || echo "FreeSWITCH source not found at $(FREESWITCH_SRC)"

# Docker build (optional)
docker-build:
	docker build -t mod-ws-audio-builder .
	docker run --rm -v $(PWD):/workspace mod-ws-audio-builder

.PHONY: all install clean uninstall debug check-deps docker-build

# Installation script
install-deps-ubuntu:
	sudo apt-get update
	sudo apt-get install -y \
		build-essential \
		libwebsockets-dev \
		libcjson-dev \
		libfreeswitch-dev

install-deps-centos:
	sudo yum install -y \
		gcc make \
		libwebsockets-devel \
		cjson-devel \
		freeswitch-devel